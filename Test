import React, { useEffect, useMemo, useState } from "react";

// Canvas‑ready single‑file ETCO2 quiz
// White background • progress + score • Back/Submit/Next
// Green highlight for correct, red for wrong pick, black border on selection pre‑submit
// Shows image at top of each question (when provided)
// Short explanation when wrong; end review of missed questions (with images)
// Randomizes question order and option order; supports single and multi‑select (checkbox) and T/F

const ETCO2Quiz: React.FC = () => {
  // Normalize GitHub URLs to raw to avoid network prompts in Canvas
  const normalizeImg = (url: string) => {
    try {
      if (!url) return url;
      // strip accidental trailing '?' without params
      if (url.endsWith("?")) url = url.slice(0, -1);
      if (url.includes("github.com")) {
        if (url.includes("/blob/")) {
          const u = new URL(url);
          const p = u.pathname.split("/").filter(Boolean);
          url = `https://raw.githubusercontent.com/${p[0]}/${p[1]}/${p[3]}/${p.slice(4).join("/")}`;
        }
        if (!url.includes("?raw=true")) url += (url.includes("?")?"&":"?")+"raw=true";
      }
      return url;
    } catch { return url; }
  };

  type Q = {
    id: string;
    text: string;
    options: string[];
    correctAnswers: number[]; // 0-based indices
    explanation: string;
    imageUrl?: string;
    imageCaption?: string;
    multipleCorrect?: boolean; // checkbox when true
    category?: string;
  };

  // Question bank (40 MC + 10 T/F = 50 total). Images used for the 5 waveform‑pattern IDs provided.
  const allQuestions: Q[] = [
    // --- Image‑anchored pattern questions (5) ---
    { id: "img_curare", category: "Waveform Pattern", imageUrl: "https://github.com/icpryde/School-Tests/blob/main/ETC02/Curare_Cleft_ETCO2.png", imageCaption: "Curare cleft", text: "What does the brief dip in the alveolar plateau most likely indicate?", options: ["Patient initiating a small inspiratory effort against ventilations","Complete accidental extubation","Severe bronchospasm with prolonged upstroke","Capnography sensor failure"], correctAnswers: [0], explanation: "A curare cleft is a small notch during phase III from patient effort against positive pressure ventilation." },
    { id: "img_extub", category: "Waveform Pattern", imageUrl: "https://github.com/icpryde/School-Tests/blob/main/ETC02/Extubation_ETCO2.png", imageCaption: "Extubation / loss of waveform", text: "This tracing most strongly suggests:", options: ["Accidental extubation or circuit disconnection","Hypoventilation with rising ETCO2","Hyperventilation with low ETCO2","Bronchoconstriction (shark fin)",], correctAnswers: [0], explanation: "Sudden loss of ETCO2 waveforms suggests extubation or disconnection until proven otherwise." },
    { id: "img_broncho", category: "Waveform Pattern", imageUrl: "https://github.com/icpryde/School-Tests/blob/main/ETC02/bronchoconstriction_ETCO2.png", imageCaption: "Bronchoconstriction (shark fin)", text: "Which best describes this waveform?", options: ["Bronchoconstriction with delayed emptying","Normal ventilation with adequate plateau","Hypoventilation with bradypnea","Curare cleft due to patient effort"], correctAnswers: [0], explanation: "The slanted upstroke and loss of plateau form a classic 'shark fin' seen in obstructive disease." },
    { id: "img_hypervent", category: "Ventilation", imageUrl: "https://github.com/icpryde/School-Tests/blob/main/ETC02/hyperventilation_ETC02.png", imageCaption: "Hyperventilation", text: "Interpret this ETCO2 trend.", options: ["Hyperventilation with decreased ETCO2 and closer wave spacing","Hypoventilation with increased ETCO2 and wider spacing","Cardiac arrest with ROSC spike","Capnograph zeroing artifact"], correctAnswers: [0], explanation: "With hyperventilation, CO2 elimination exceeds production, lowering ETCO2; tachypnea narrows spacing." },
    { id: "img_hypovent", category: "Ventilation", imageUrl: "https://github.com/icpryde/School-Tests/blob/main/ETC02/hypoventilation_ETCO2.png", imageCaption: "Hypoventilation", text: "What pattern fits hypoventilation?", options: ["Rising ETCO2 with wider spacing between waves","Falling ETCO2 with closer spacing","Flatline loss of waveform","Normal plateau at 35–45 mmHg"], correctAnswers: [0], explanation: "CO2 production exceeds elimination; ETCO2 rises and bradypnea widens the spacing." },

    // --- Core concepts: normal values & purpose (MC) ---
    { id: "mc_norm1", category: "Basics", text: "Normal ETCO2 range at the mouth is:", options: ["35–45 mmHg","20–30 mmHg","50–60 mmHg","80–100 mmHg"], correctAnswers: [0], explanation: "Normal ETCO2 is typically 35–45 mmHg." },
    { id: "mc_purpose1", category: "Basics", text: "ETCO2 primarily monitors:", options: ["Ventilation","Oxygenation","Hemoglobin concentration","Serum bicarbonate"], correctAnswers: [0], explanation: "ETCO2 reflects ventilation; SpO2 reflects oxygenation." },
    { id: "mc_compare_spo2", category: "Basics", text: "Compared to SpO2, ETCO2 has:", options: ["More immediate response to ventilation changes","More delay to changes","Identical delay","No relationship"], correctAnswers: [0], explanation: "ETCO2 changes immediately with ventilation; SpO2 often lags." },

    // --- Waveform phases (MC) ---
    { id: "mc_phase1", category: "Phases", imageUrl: "https://github.com/icpryde/School-Tests/blob/main/random/ETCO2-1.png", imageCaption: "ETCO2 phases", text: "Phase A–B corresponds to:", options: ["Start of exhalation from anatomic dead space (no CO2)","Late alveolar exhalation (plateau)","Inspiratory downstroke","Expiratory upstroke replacing dead space"], correctAnswers: [0], explanation: "Phase 1 (A–B) is dead space gas with near‑zero CO2." },
    { id: "mc_phase2", category: "Phases", imageUrl: "https://github.com/icpryde/School-Tests/blob/main/random/ETCO2-1.png", imageCaption: "ETCO2 phases", text: "Phase B–C is best described as:", options: ["Expiratory upstroke as alveolar gas mixes in","Pure inspiratory phase","Alveolar plateau","Inspiratory baseline"], correctAnswers: [0], explanation: "Phase 2 mixes dead space with alveolar gas, causing a rapid rise." },
    { id: "mc_phase3", category: "Phases", imageUrl: "https://github.com/icpryde/School-Tests/blob/main/random/ETCO2-1.png", imageCaption: "ETCO2 phases", text: "Phase C–D represents:", options: ["Alveolar plateau (late expiration)","Inspiratory downstroke","Anatomic dead space","Sensor zeroing"], correctAnswers: [0], explanation: "Phase 3 is the alveolar plateau; point D is ETCO2." },
    { id: "mc_phase4", category: "Phases", imageUrl: "https://github.com/icpryde/School-Tests/blob/main/random/ETCO2-1.png", imageCaption: "ETCO2 phases", text: "Point D indicates:", options: ["End‑tidal CO2 value","Start of inspiration","Anatomic dead space","Equipment calibration"], correctAnswers: [0], explanation: "Point D corresponds to the measured ETCO2." },
    { id: "mc_phase5", category: "Phases", imageUrl: "https://github.com/icpryde/School-Tests/blob/main/random/ETCO2-1.png", imageCaption: "ETCO2 phases", text: "Phase D–E is:", options: ["Inspiratory downstroke with rapid CO2 fall","Expiratory upstroke","Alveolar plateau","Anatomic dead space"], correctAnswers: [0], explanation: "Inspiration washes out CO2, returning to baseline." },
    { id: "mc_phase0", category: "Phases", imageUrl: "https://github.com/icpryde/School-Tests/blob/main/random/ETCO2-1.png", imageCaption: "ETCO2 phases", text: "Segment E–A shows:", options: ["Continued inspiration at baseline (no CO2)","Late expiration","Mixing of dead space","Upstroke artifact"], correctAnswers: [0], explanation: "Inspiration continues with near‑zero CO2." },

    // --- Hypo/Hyperventilation (MC) ---
    { id: "mc_hypov_def", category: "Ventilation", text: "Hypoventilation means:", options: ["CO2 production exceeds elimination","Elimination exceeds production","No net CO2 exchange","Only oxygenation change"], correctAnswers: [0], explanation: "Hypoventilation builds CO2, increasing ETCO2." },
    { id: "mc_hyperv_def", category: "Ventilation", text: "Hyperventilation means:", options: ["CO2 elimination exceeds production","Production exceeds elimination","Only oxygen increases","Tidal volume zero"], correctAnswers: [0], explanation: "Hyperventilation lowers ETCO2." },

    // --- Bronchoconstriction / Obstructive (MC) ---
    { id: "mc_sharkfin_why", category: "Obstructive", text: "The 'shark fin' shape results primarily from:", options: ["Delayed transition from dead space to alveolar gas","Complete loss of alveolar gas","Immediate inspiratory effort","Excessive PEEP"], correctAnswers: [0], explanation: "Airway resistance delays emptying; plateau is blunted." },
    { id: "mc_obstructive_dx", category: "Obstructive", text: "A shark fin waveform is most consistent with:", options: ["Asthma/COPD","Pulmonary edema without obstruction","Pulmonary embolism with zero perfusion","Normal lungs"], correctAnswers: [0], explanation: "Obstructive physiology like asthma or COPD." },

    // --- Curare cleft / patient effort (MC) ---
    { id: "mc_cleft_mean", category: "Ventilation", text: "A small notch during the alveolar plateau while on PPV suggests:", options: ["Patient inspiratory effort","Exhausted CO2 absorber","Pure hyperventilation","Complete extubation"], correctAnswers: [0], explanation: "Classic curare cleft indicates spontaneous effort." },

    // --- Extubation / loss (MC) ---
    { id: "mc_extub_loss", category: "Airway", text: "Sudden and persistent loss of ETCO2 waveform should prompt:", options: ["Immediate check for tube position or disconnection","Increase sedation dose","Decrease ventilatory rate","Ignore if SpO2 is normal"], correctAnswers: [0], explanation: "Verify airway continuity first." },

    // --- Arrest / ROSC (MC) ---
    { id: "mc_cpr_10", category: "Arrest", text: "During effective chest compressions, ETCO2 is often around:", options: ["~10 mmHg","~40 mmHg","~60 mmHg","~0 mmHg"], correctAnswers: [0], explanation: "Effective CPR often produces ETCO2 near 10 mmHg." },
    { id: "mc_rosc_spike", category: "Arrest", text: "A sudden large rise in ETCO2 during CPR most likely indicates:", options: ["ROSC","Tube obstruction","Battery failure","Return to asystole"], correctAnswers: [0], explanation: "ROSC increases perfusion and CO2 delivery to lungs, spiking ETCO2." },
    { id: "mc_vsa_low", category: "Arrest", text: "In a patient VSA without perfusion, ETCO2 is typically:", options: ["Very low and quickly dropping","High and stable","Normal range","Unchanged"], correctAnswers: [0], explanation: "Lack of circulation lowers ETCO2 dramatically." },

    // --- Hardware / how it works (MC) ---
    { id: "mc_infrared", category: "Hardware", text: "Capnography measures CO2 because exhaled CO2:", options: ["Absorbs infrared light","Emits ultraviolet light","Reflects visible red only","Generates an electric signal"], correctAnswers: [0], explanation: "Infrared absorption by CO2 enables quantitative measurement." },

    // --- SpO2 vs ETCO2 (MC) ---
    { id: "mc_monitor_diff1", category: "Compare", text: "SpO2 and ETCO2 mainly monitor:", options: ["Oxygenation vs ventilation","Ventilation vs oxygenation","Perfusion vs conduction","Conduction vs diffusion"], correctAnswers: [0], explanation: "SpO2 = oxygenation; ETCO2 = ventilation." },

    // --- Patterns & interpretation (more MC) ---
    { id: "mc_tachypnea_spacing", category: "Patterns", text: "Tachypnea typically makes ETCO2 waves:", options: ["Closer together","Further apart","Taller","Disappear"], correctAnswers: [0], explanation: "Higher rate shortens cycle length." },
    { id: "mc_bradypnea_spacing", category: "Patterns", text: "Bradypnea typically makes ETCO2 waves:", options: ["Further apart","Closer together","Shorter","Tall with cleft"], correctAnswers: [0], explanation: "Lower rate widens cycle spacing." },
    { id: "mc_peep_baseline", category: "Patterns", text: "Excess PEEP most characteristically causes:", options: ["Elevated baseline that may not return fully to zero","Sudden flatline","Shark fin upstroke","Curare cleft"], correctAnswers: [0], explanation: "Air trapping/PEEP can elevate baseline CO2 between breaths." },
    { id: "mc_rebreath", category: "Patterns", text: "Rebreathing is suggested by:", options: ["Elevated inspiratory baseline above zero","Falling ETCO2 to near zero","Loss of plateau only","Single notch in plateau"], correctAnswers: [0], explanation: "CO2 present during inspiration raises baseline." },

    // --- Cannula vs inline (MC) ---
    { id: "mc_interface", category: "Hardware", text: "ETCO2 can be measured via:", options: ["Inline adapter or nasal cannula","Pulse oximeter only","Arterial line only","ECG electrodes"], correctAnswers: [0], explanation: "Mainstream (inline) and sidestream (cannula) are common." },

    // --- Dead space / alveolar gas (MC) ---
    { id: "mc_deadspace0", category: "Phases", imageUrl: "https://github.com/icpryde/School-Tests/blob/main/random/ETCO2-1.png", imageCaption: "ETCO2 phases", text: "Which segment reflects mostly anatomic dead space?", options: ["A–B","B–C","C–D","D–E"], correctAnswers: [0], explanation: "A–B is dead space with negligible CO2." },
    { id: "mc_alveolar_plat", category: "Phases", imageUrl: "https://github.com/icpryde/School-Tests/blob/main/random/ETCO2-1.png", imageCaption: "ETCO2 phases", text: "The alveolar plateau is:", options: ["C–D","A–B","B–C","E–A"], correctAnswers: [0], explanation: "C–D is the late expiratory alveolar gas." },

    // --- More applied MC ---
    { id: "mc_pe_vs_etco2", category: "Applied", text: "In massive PE with near‑zero lung perfusion, ETCO2 will often:", options: ["Fall despite adequate ventilation","Rise due to hypercapnia","Remain normal","Show a curare cleft"], correctAnswers: [0], explanation: "Poor perfusion lowers CO2 delivery to alveoli and ETCO2." },
    { id: "mc_sedation_effort", category: "Applied", text: "Emerging patient effort during RSI maintenance is first seen as:", options: ["Notch in phase III (curare cleft)","Shark fin upstroke","Flatline","Hyperventilation pattern"], correctAnswers: [0], explanation: "Small inspiratory efforts create a cleft on the plateau." },
    { id: "mc_tube_in_esoph", category: "Applied", text: "Which best suggests esophageal intubation?", options: ["No sustained ETCO2 after several ventilations","Shark fin waveform","High stable ETCO2","Cleft on plateau"], correctAnswers: [0], explanation: "Failure to obtain sustained ETCO2 strongly suggests esophageal placement." },
    { id: "mc_cpr_quality", category: "Applied", text: "ETCO2 trending downward during CPR can indicate:", options: ["Deteriorating compression quality or fatigue","Hyperventilation only","Resolution of arrest","Artifact only"], correctAnswers: [0], explanation: "Lower perfusion from poor compressions reduces ETCO2." },
    { id: "mc_post_rosc", category: "Applied", text: "After ROSC, persistent ETCO2 >45 mmHg is most consistent with:", options: ["Hypoventilation requiring rate/TV adjustment","Hyperventilation","Zero perfusion","Esophageal tube"], correctAnswers: [0], explanation: "Elevated ETCO2 often means insufficient ventilation relative to production." },

    // --- T/F (10) ---
    { id: "tf_norm", category: "T/F", text: "T/F: Normal ETCO2 is 35–45 mmHg.", options: ["True","False"], correctAnswers: [0], explanation: "35–45 mmHg is the typical normal range." },
    { id: "tf_vent", category: "T/F", text: "T/F: ETCO2 primarily reflects ventilation, not oxygenation.", options: ["True","False"], correctAnswers: [0], explanation: "SpO2 is for oxygenation; ETCO2 is for ventilation." },
    { id: "tf_phase3", category: "T/F", text: "T/F: Phase C–D is the alveolar plateau.", options: ["True","False"], correctAnswers: [0], explanation: "Yes—late expiration, mostly alveolar gas." },
    { id: "tf_pointd", category: "T/F", text: "T/F: Point D equals the measured ETCO2 value.", options: ["True","False"], correctAnswers: [0], explanation: "End‑tidal is sampled at end exhalation at point D." },
    { id: "tf_hyper_low", category: "T/F", text: "T/F: Hyperventilation lowers ETCO2.", options: ["True","False"], correctAnswers: [0], explanation: "Elimination exceeds production, so ETCO2 falls." },
    { id: "tf_hypo_high", category: "T/F", text: "T/F: Hypoventilation raises ETCO2.", options: ["True","False"], correctAnswers: [0], explanation: "Production exceeds elimination, so ETCO2 rises." },
    { id: "tf_sharkfin", category: "T/F", text: "T/F: A shark fin waveform suggests obstructive disease.", options: ["True","False"], correctAnswers: [0], explanation: "Asthma/COPD commonly show this shape." },
    { id: "tf_cleft", category: "T/F", text: "T/F: A curare cleft indicates patient effort against ventilation.", options: ["True","False"], correctAnswers: [0], explanation: "It is a sign of spontaneous effort during PPV." },
    { id: "tf_extub", category: "T/F", text: "T/F: Sudden loss of ETCO2 may indicate extubation or disconnection.", options: ["True","False"], correctAnswers: [0], explanation: "Always confirm tube and circuit first." },
    { id: "tf_cpr10", category: "T/F", text: "T/F: During effective CPR, ETCO2 around 10 mmHg is typical.", options: ["True","False"], correctAnswers: [0], explanation: "About 10 mmHg is a common target during compressions." },
  ];

  // Randomize questions and options, while remapping correct indices
  const [questions, setQuestions] = useState<Q[]>([]);
  useEffect(() => {
    const shuffle = <T,>(a: T[]) => { const x=[...a]; for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]];} return x; };
    const randomized = allQuestions.map(q=>{
      const idx=q.options.map((_,i)=>i);
      const perm=shuffle(idx);
      const opts=perm.map(p=>q.options[p]);
      const corr=q.correctAnswers.map(o=>perm.indexOf(o));
      return {...q, options:opts, correctAnswers:corr};
    });
    setQuestions(shuffle(randomized));
  }, []);

  const total = questions.length;
  const [current, setCurrent] = useState(0);
  const [submitted, setSubmitted] = useState(false);
  const [selected, setSelected] = useState<Record<number, Record<number, boolean>>>({});
  const [score, setScore] = useState(0);
  const [answered, setAnswered] = useState(0);
  const [done, setDone] = useState(false);
  const [misses, setMisses] = useState<Array<{questionIndex:number;question:string;userSelection:number[];correctAnswers:number[];options:string[];explanation:string;category?:string;imageUrl?:string;imageCaption?:string;}>>([]);

  const cq = questions[current];
  const isSelected = (i:number)=>!!selected[current]?.[i];
  const toggle = (i:number)=>{ if(submitted||!cq) return; if(cq.multipleCorrect){ setSelected(p=>({...p,[current]:{...(p[current]||{}),[i]:!(p[current]?.[i])}})); } else { setSelected(p=>({...p,[current]:{[i]:true}})); } };

  const submit = ()=>{
    if(submitted||!cq) return;
    const user = Object.entries(selected[current]||{}).filter(([,v])=>v).map(([k])=>+k);
    let ok=false;
    if(cq.multipleCorrect){ const c=new Set(cq.correctAnswers), u=new Set(user); ok=user.length===cq.correctAnswers.length && [...c].every(i=>u.has(i)); }
    else { ok=user.length===1 && cq.correctAnswers.includes(user[0]); }
    setSubmitted(true); setAnswered(x=>x+1);
    if(ok){ setScore(s=>s+1);} else { setMisses(m=>[...m,{questionIndex:current,question:cq.text,userSelection:user,correctAnswers:cq.correctAnswers,options:cq.options,explanation:cq.explanation,category:cq.category,imageUrl:cq.imageUrl,imageCaption:cq.imageCaption}]); }
    if(answered+1===total) setDone(true);
  };

  const prev=()=>{ if(current>0){ setCurrent(i=>i-1); setSubmitted(false);} };
  const next=()=>{ if(current<total-1){ setCurrent(i=>i+1); setSubmitted(false);} };
  const reset=()=>{ setCurrent(0); setSubmitted(false); setSelected({}); setScore(0); setAnswered(0); setDone(false); setMisses([]); };

  const progress = useMemo(()=> total? (answered/total)*100 : 0, [answered,total]);
  const optClass = (i:number)=>{
    const b="p-3 rounded-lg border transition-colors cursor-pointer";
    if(!submitted){ return b+" "+(isSelected(i)?"border-2 border-black bg-gray-50":"border-gray-300 hover:bg-gray-50"); }
    const correct=cq?.correctAnswers.includes(i);
    const picked=isSelected(i);
    if(correct) return b+" border-green-600 bg-green-200";
    if(picked) return b+" border-red-600 bg-red-200";
    return b+" border-gray-300";
  };

  if(!total) return <div className="p-6 text-center">Loading…</div>;

  return (
    <div className="min-h-screen bg-white text-gray-900">
      <div className="max-w-4xl mx-auto p-6">
        {!done ? (
          <>
            <div className="mb-6 text-center">
              <h1 className="text-2xl font-bold">ETCO2 Waveform & Interpretation Quiz</h1>
              <p className="text-gray-600 mt-1">{answered} of {total} answered • Score: {score}/{answered}</p>
              <div className="w-full bg-gray-200 rounded-full h-3 mt-3"><div className="bg-blue-600 h-3 rounded-full" style={{width:`${progress}%`}}/></div>
            </div>
            {cq && (
              <div className="mb-6">
                {cq.imageUrl && (
                  <figure className="mb-4">
                    <img src={normalizeImg(cq.imageUrl)} alt={cq.imageCaption||"ETCO2 waveform"} className="w-full max-h-[320px] object-contain rounded border" />
                    {submitted && cq.imageCaption && (
                      <figcaption className="text-sm text-gray-600 italic mt-1">Waveform: {cq.imageCaption}</figcaption>
                    )}
                  </figure>
                )}
                <div className="bg-gray-100 p-4 rounded-lg mb-4">
                  <p className="text-sm text-gray-500">{cq.category?`${cq.category} • `:""}Question {current+1} of {total}</p>
                  <h2 className="text-lg font-semibold mt-1">{cq.text}</h2>
                </div>
                <div className="space-y-2">
                  {cq.options.map((opt,i)=> (
                    <div key={i} className={optClass(i)} onClick={()=>toggle(i)}>
                      <div className="flex items-start">
                        <div className="mr-3 mt-0.5">
                          {!cq.multipleCorrect ? (
                            <div className={`w-5 h-5 border-2 rounded-full flex items-center justify-center ${isSelected(i)?"bg-blue-500 border-blue-500":"border-gray-400"}`}>{isSelected(i)&&<div className="w-3 h-3 bg-white rounded-full"/>}</div>
                          ) : (
                            <div className={`w-5 h-5 border-2 rounded flex items-center justify-center ${isSelected(i)?"bg-blue-500 border-blue-500":"border-gray-400"}`}>{isSelected(i)&&<span className="text-white text-sm">✓</span>}</div>
                          )}
                        </div>
                        <span className="whitespace-pre-line">{opt}</span>
                      </div>
                    </div>
                  ))}
                </div>
                {/* Show short explanation only if wrong */}
                {submitted && cq && (()=>{ const user=Object.entries(selected[current]||{}).filter(([,v])=>v).map(([k])=>+k); const ok=(!cq.multipleCorrect && user.length===1 && cq.correctAnswers.includes(user[0])) || (cq.multipleCorrect && user.length===cq.correctAnswers.length && cq.correctAnswers.every(i=>user.includes(i))); return !ok ? (<div className="mb-6 p-4 bg-gray-100 rounded-lg border border-gray-300"><h3 className="font-semibold mb-2">Explanation</h3><p>{cq.explanation}</p></div>) : null; })()}
                <div className="flex justify-between">
                  <button onClick={prev} disabled={current===0} className={`px-4 py-2 rounded ${current===0?"bg-gray-300 cursor-not-allowed":"bg-gray-500 text-white hover:bg-gray-600"}`}>Back</button>
                  {!submitted ? (
                    <button onClick={submit} className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Submit Answer</button>
                  ) : (
                    <button onClick={next} disabled={current===total-1} className={`px-4 py-2 rounded ${current===total-1?"bg-gray-300 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`}>Next</button>
                  )}
                </div>
              </div>
            )}
          </>
        ) : (
          <div>
            <h1 className="text-2xl font-bold text-center mb-6">Quiz Completed!</h1>
            <div className="mb-6 p-4 bg-gray-100 rounded-lg text-center">
              <p className="text-lg">Score: {score}/{total} • {Math.round((score/(total||1))*100)}%</p>
            </div>
            {misses.length>0 && (
              <div className="mb-6">
                <h2 className="text-xl font-semibold mb-3">Review the ones you missed</h2>
                <div className="space-y-3">
                  {misses.map((m,idx)=> (
                    <div key={idx} className="p-3 bg-gray-100 rounded border">
                      {m.imageUrl && <img src={normalizeImg(m.imageUrl)} alt={m.imageCaption||"ETCO2 waveform"} className="w-full max-h-[160px] object-contain rounded border mb-2"/>}
                      <p className="text-sm text-gray-500 mb-1">{m.category?`${m.category} • `:""}Question {m.questionIndex+1}</p>
                      <div className="space-y-1 mb-2">
                        {m.options.map((opt,i)=>{ const c=m.correctAnswers.includes(i); const u=m.userSelection.includes(i); return (
                          <div key={i} className={`p-2 rounded border ${c?"bg-green-200 border-green-600":u?"bg-red-200 border-red-600":"bg-white"}`}>
                            {opt}{c && <span className="ml-2 text-green-700 font-semibold">✓</span>}{u&&!c && <span className="ml-2 text-red-700 font-semibold">(yours)</span>}
                          </div>
                        ); })}
                      </div>
                      <p className="text-sm"><span className="font-semibold">Why:</span> {m.explanation}</p>
                    </div>
                  ))}
                </div>
              </div>
            )}
            <div className="text-center"><button onClick={reset} className="px-6 py-3 bg-blue-600 text-white rounded hover:bg-blue-700">Start Over</button></div>
          </div>
        )}
      </div>
    </div>
  );
};

export default ETCO2Quiz;
